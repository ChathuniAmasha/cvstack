<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CVStack • AI Filtering</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    details > summary { cursor: pointer; }
    code { word-break: break-word; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">
  <div class="max-w-5xl mx-auto p-6">
    
    <header class="mb-8 flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">CVStack Dashboard</h1>
        <p class="text-sm text-gray-500 mt-1">Upload CVs, manage skills, and rank candidates with AI.</p>
      </div>
      <div class="text-right hidden sm:block">
        <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold tracking-wide">SYSTEM ONLINE</span>
      </div>
    </header>

    <div class="mb-6 bg-white p-4 rounded-xl border border-gray-200 shadow-sm hidden">
      <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2" for="apiBase">API Base URL</label>
      <input id="apiBase" type="text" class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm bg-gray-50" placeholder="http://127.0.0.1:8080">
    </div>

    <section class="mb-8">
      <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
        <span class="bg-gray-900 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
        Upload CV (PDF/TXT)
      </h2>
      <div class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm">
        <div class="flex items-center gap-4">
          <label class="flex-1 cursor-pointer group">
            <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-xl px-6 py-8 text-center hover:border-indigo-500 hover:bg-indigo-50 transition">
              <span class="text-sm text-gray-600 group-hover:text-indigo-600 font-medium" id="fileNameDisplay">Click or Drag PDF here</span>
              <input id="fileInput" type="file" accept="application/pdf" class="hidden" />
            </div>
          </label>
          <div class="flex flex-col gap-2">
            <button id="uploadBtn" class="px-6 py-3 rounded-xl bg-indigo-600 text-white font-medium text-sm hover:bg-indigo-700 transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
              Upload & Extract
            </button>
          </div>
        </div>
        
        <div class="mt-4 flex items-center gap-3">
            <div id="spinner" class="hidden animate-spin rounded-full h-5 w-5 border-2 border-indigo-600 border-t-transparent"></div>
            <div id="status" class="text-sm font-medium text-gray-600"></div>
        </div>
        <div id="errorBox" class="hidden mt-3 p-3 rounded-lg border border-red-200 bg-red-50 text-red-800 text-sm"></div>
      </div>
    </section>

    <section class="mb-8">
      <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
        <span class="bg-gray-900 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
        Upload Skill Catalog (JSON)
      </h2>
      <div class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm">
        <div class="flex items-center gap-3 mb-4">
          <label class="inline-flex items-center px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 text-sm font-medium hover:bg-gray-50 cursor-pointer shadow-sm transition">
            Choose File
            <input id="catalogFileInput" type="file" accept="application/json" class="hidden" />
          </label>
          <span id="catalogFileName" class="text-sm text-gray-500">No file chosen</span>
        </div>

        <button id="uploadCatalogBtn" class="w-full sm:w-auto px-6 py-2.5 rounded-xl bg-green-600 text-white text-sm font-medium hover:bg-green-700 transition shadow-sm disabled:opacity-50">
          Upload & Index
        </button>

        <div id="catalogStatus" class="mt-3 text-sm text-gray-600"></div>
        <div id="catalogError" class="hidden mt-2 p-3 rounded-lg border border-red-200 bg-red-50 text-red-800 text-sm"></div>
        
        <div class="mt-6">
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">Stored Skills in Database</p>
            <div id="skillTagsContainer" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-2 border border-gray-100 rounded-lg bg-gray-50">
                <span class="text-xs text-gray-400 italic p-1">Loading skills from database...</span>
            </div>
        </div>
      </div>
    </section>

    <section class="mb-12">
      <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
        <span class="bg-gray-900 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">3</span>
        Search Candidates
      </h2>
      
      <div class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm">
        <label class="block text-sm font-medium text-gray-900 mb-2">Select Search Mode</label>
        
        <div class="flex gap-2 mb-6">
            <div class="relative flex-1">
                <select id="skillSelect" class="w-full appearance-none rounded-xl border border-gray-300 bg-white px-4 py-3 pr-8 text-sm focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm">
                    <option value="">Loading skills...</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
            </div>
            
            <button id="searchSkillBtn" class="px-6 py-3 rounded-xl bg-indigo-600 text-white font-medium text-sm hover:bg-indigo-700 transition shadow-md min-w-[120px]">
                Search
            </button>
        </div>

        <div id="searchError" class="hidden mb-4 p-3 rounded-lg border border-red-200 bg-red-50 text-red-800 text-sm"></div>

        <div id="searchResults" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-md font-bold text-gray-900">Matching Candidates</h3>
                <span id="resultCount" class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-md"></span>
            </div>
            
            <div class="overflow-x-auto border border-gray-200 rounded-xl">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                        <tr>
                            <th class="px-6 py-3 font-semibold">#</th>
                            <th class="px-6 py-3 font-semibold">Name</th>
                            <th class="px-6 py-3 font-semibold">Email</th>
                            <th class="px-6 py-3 font-semibold w-1/3">Matched Skills</th>
                            <th class="px-6 py-3 font-semibold text-right">Match Score</th>
                        </tr>
                    </thead>
                    <tbody id="searchResultsBody" class="divide-y divide-gray-100 bg-white">
                        </tbody>
                </table>
            </div>
        </div>
      </div>
    </section>

    <details class="mb-10">
        <summary class="text-xs text-gray-400 cursor-pointer hover:text-gray-600">Debug: View Raw API Response</summary>
        <pre id="jsonRaw" class="mt-2 p-4 bg-gray-900 text-green-400 rounded-xl text-xs overflow-x-auto mono"></pre>
    </details>

  </div>

  <script>
    // --- Configuration ---
    const getApiBase = () => {
        const val = document.getElementById('apiBase').value.trim();
        return val ? val.replace(/\/+$/, '') : 'http://127.0.0.1:8080';
    };

    // --- DOM Elements ---
    const fileInput = document.getElementById('fileInput');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const uploadBtn = document.getElementById('uploadBtn');
    const statusEl = document.getElementById('status');
    const spinner = document.getElementById('spinner');
    const errorBox = document.getElementById('errorBox');
    const jsonRaw = document.getElementById('jsonRaw');

    // --- 1. CV UPLOAD LOGIC ---
    let selectedFile = null;

    document.getElementById('dropZone').addEventListener('click', () => fileInput.click());
    
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (file) {
            selectedFile = file;
            fileNameDisplay.textContent = file.name;
            statusEl.textContent = "";
            errorBox.classList.add('hidden');
        }
    });

    uploadBtn.addEventListener('click', async () => {
        if (!selectedFile) {
            showError("Please select a PDF file first.");
            return;
        }

        setBusy(true);
        errorBox.classList.add('hidden');
        
        try {
            const fd = new FormData();
            fd.append('file', selectedFile);

            const res = await fetch(`${getApiBase()}/ingest`, {
                method: 'POST',
                body: fd
            });

            if (!res.ok) {
                const txt = await res.text();
                try {
                    const errJson = JSON.parse(txt);
                    throw new Error(errJson.detail || txt);
                } catch {
                    throw new Error(`Server Error: ${txt}`);
                }
            }

            const data = await res.json();
            statusEl.textContent = "Upload & Extraction Successful!";
            statusEl.className = "text-sm font-medium text-green-600";
            jsonRaw.textContent = JSON.stringify(data, null, 2);

        } catch (err) {
            showError(err.message);
        } finally {
            setBusy(false);
        }
    });

    // --- 2. SKILL CATALOG LOGIC ---
    const catalogInput = document.getElementById('catalogFileInput');
    const uploadCatalogBtn = document.getElementById('uploadCatalogBtn');
    const catalogStatus = document.getElementById('catalogStatus');
    const catalogError = document.getElementById('catalogError');
    const skillSelect = document.getElementById('skillSelect');
    const skillTagsContainer = document.getElementById('skillTagsContainer');

    let selectedCatalog = null;

    catalogInput.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (file) {
            selectedCatalog = file;
            document.getElementById('catalogFileName').textContent = file.name;
            catalogError.classList.add('hidden');
        }
    });

    uploadCatalogBtn.addEventListener('click', async () => {
        if (!selectedCatalog) {
            catalogError.textContent = "Select a JSON file first.";
            catalogError.classList.remove('hidden');
            return;
        }

        uploadCatalogBtn.disabled = true;
        uploadCatalogBtn.textContent = "Uploading...";
        catalogStatus.textContent = "";

        try {
            const fd = new FormData();
            fd.append('file', selectedCatalog);

            const res = await fetch(`${getApiBase()}/skills/catalog`, { method: 'POST', body: fd });
            
            if (!res.ok) throw new Error(await res.text());

            const data = await res.json();
            catalogStatus.textContent = "Successfully uploaded catalog!";
            catalogStatus.className = "mt-3 text-sm font-medium text-green-600";
            
            // Reload dropdown and tags
            await loadSkills();

        } catch (err) {
            catalogError.textContent = err.message;
            catalogError.classList.remove('hidden');
        } finally {
            uploadCatalogBtn.disabled = false;
            uploadCatalogBtn.textContent = "Upload & Index";
        }
    });

    // --- FETCH & DISPLAY SKILLS (Populates Tags + Unified Dropdown) ---
    async function loadSkills() {
        console.log("Fetching skills...");
        skillTagsContainer.innerHTML = '<span class="text-xs text-gray-400 italic">Loading...</span>';
        
        try {
            const res = await fetch(`${getApiBase()}/skills/catalog/list`);
            if (!res.ok) {
                console.warn("Could not fetch skills.");
                skillSelect.innerHTML = '<option value="">Failed to load skills</option>';
                skillTagsContainer.innerHTML = '<span class="text-xs text-red-400">Error loading skills</span>';
                return;
            }

            const data = await res.json();
            const skills = Array.isArray(data) ? data : (data.skills || []);

            console.log(`Loaded ${skills.length} skills.`);

            // 1. Populate Dropdown with Special "Match All" Option
            skillSelect.innerHTML = '';
            
            // Default placeholder
            const defaultOpt = document.createElement('option');
            defaultOpt.value = "";
            defaultOpt.text = "-- Select a Search Mode --";
            skillSelect.appendChild(defaultOpt);

            // Special Option: Match All
            if (skills.length > 0) {
                const allOpt = document.createElement('option');
                allOpt.value = "ALL_CATALOG_MATCH"; 
                allOpt.text = "★ Match Against Full Catalog (All Skills)";
                allOpt.style.fontWeight = "bold";
                // Style hack for standard select
                skillSelect.appendChild(allOpt);

                const sep = document.createElement('option');
                sep.disabled = true;
                sep.text = "──────────────";
                skillSelect.appendChild(sep);
            }

            // Individual Skills
            skills.forEach(skill => {
                const opt = document.createElement('option');
                opt.value = skill; 
                opt.text = skill;
                skillSelect.appendChild(opt);
            });

            // 2. Populate Blue Tags for preview
            if (skills.length === 0) {
                skillTagsContainer.innerHTML = '<span class="text-xs text-gray-400">No skills in database. Upload a catalog.</span>';
            } else {
                skillTagsContainer.innerHTML = '';
                skills.forEach(skill => {
                    const tag = document.createElement('span');
                    tag.className = "px-2 py-1 bg-indigo-50 text-indigo-700 text-xs rounded-md border border-indigo-100";
                    tag.textContent = skill;
                    skillTagsContainer.appendChild(tag);
                });
            }

        } catch (err) {
            console.error(err);
        }
    }

    // --- 3. UNIFIED SEARCH LOGIC ---
    const searchSkillBtn = document.getElementById('searchSkillBtn');
    const searchResults = document.getElementById('searchResults');
    const searchResultsBody = document.getElementById('searchResultsBody');
    const searchError = document.getElementById('searchError');
    const resultCount = document.getElementById('resultCount');

    searchSkillBtn.addEventListener('click', async () => {
        const selection = skillSelect.value;
        
        if (!selection) {
            searchError.textContent = "Please select an option from the dropdown.";
            searchError.classList.remove('hidden');
            return;
        }

        // Logic Switch:
        // If "ALL_CATALOG_MATCH" -> Call /search/catalog (Total Score)
        // If Specific Skill      -> Call /search/catalog/skill (Single)
        
        let url, payload;

        if (selection === "ALL_CATALOG_MATCH") {
            url = `${getApiBase()}/search/catalog`;
            payload = { limit: 50 };
        } else {
            url = `${getApiBase()}/search/catalog/skill`;
            payload = { skill: selection, limit: 50 };
        }

        searchError.classList.add('hidden');
        searchResults.classList.add('hidden');
        searchResultsBody.innerHTML = '';
        searchSkillBtn.disabled = true;
        searchSkillBtn.textContent = "Searching...";

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error(await res.text());

            const data = await res.json();
            const results = data.results || [];
            
            resultCount.textContent = `Found ${results.length}`;

            if (results.length === 0) {
                searchError.textContent = "No candidates found.";
                searchError.classList.remove('hidden');
                return;
            }

            // Render Rows
            results.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition border-b border-gray-100";
                
                // Format skills as pills
                let skillsHtml = '<span class="text-gray-400 italic text-xs">None</span>';
                if (row.matched_skills && Array.isArray(row.matched_skills) && row.matched_skills.length > 0) {
                    skillsHtml = row.matched_skills.map(s => 
                        `<span class="inline-block px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded-full mr-1 mb-1">${s}</span>`
                    ).join('');
                }

                tr.innerHTML = `
                    <td class="px-6 py-4 text-gray-500">${index + 1}</td>
                    <td class="px-6 py-4 font-medium text-gray-900">${row.name || row.full_name || 'Unknown'}</td>
                    <td class="px-6 py-4 text-gray-600">${row.email || '-'}</td>
                    <td class="px-6 py-4">${skillsHtml}</td>
                    <td class="px-6 py-4 text-right font-bold text-gray-900">${row.match_score !== undefined ? row.match_score : '-'}</td>
                `;
                searchResultsBody.appendChild(tr);
            });

            searchResults.classList.remove('hidden');

        } catch (err) {
            searchError.textContent = err.message || "Search failed";
            searchError.classList.remove('hidden');
        } finally {
            searchSkillBtn.disabled = false;
            searchSkillBtn.textContent = "Search";
        }
    });

    // --- UTILS ---
    function setBusy(b) {
        uploadBtn.disabled = b;
        if(b) {
            spinner.classList.remove('hidden');
            statusEl.textContent = "Processing...";
        } else {
            spinner.classList.add('hidden');
        }
    }

    function showError(msg) {
        errorBox.textContent = msg;
        errorBox.classList.remove('hidden');
        statusEl.textContent = "";
        spinner.classList.add('hidden');
    }

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', loadSkills);

  </script>
</body>
</html>